<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Punto de Venta Simple</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb;  /* gray-200 */
      --accent:#22c55e;/* green-500 */
      --accent-2:#38bdf8;/* sky-400 */
      --danger:#ef4444;/* red-500 */
      --card:#0b1220; /* custom */
      --border:#1f2937;/* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#0b1020); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    }
    header{
      padding:16px 20px; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(11,16,32,.8); backdrop-filter:saturate(140%) blur(6px);
      display:flex; align-items:center; gap:16px; z-index:10;
    }
    header h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.3px}
    .container{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto}
    @media (max-width: 960px){.container{grid-template-columns:1fr}}

    .card{background:radial-gradient(1200px 400px at top left, rgba(56,189,248,.04), transparent 40%), var(--card);
      border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.25)}
    .card header{position:unset; background:transparent; border-bottom:1px solid var(--border)}
    .section{padding:16px}

    .row{display:flex; gap:10px; align-items:center}
    .grow{flex:1}

    input, select, button{border-radius:10px; border:1px solid var(--border); background:#0e1426; color:var(--text)}
    input, select{padding:10px 12px; width:100%}
    button{padding:10px 12px; cursor:pointer; transition:.2s transform, .2s opacity, .2s background}
    button:active{transform:translateY(1px)}

    .btn{background:#0f172a; border:1px solid #1f2937}
    .btn.primary{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#16a34a; color:white}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#b91c1c; color:white}
    .btn.blue{background:linear-gradient(180deg,#38bdf8,#0284c7); border-color:#0284c7; color:white}

    .list{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
    @media (max-width:720px){.list{grid-template-columns:1fr}}

    .product{display:flex; align-items:center; gap:10px; border:1px dashed #20304a; padding:10px; border-radius:12px; background:rgba(2, 6, 23, .5)}
    .product small{color:var(--muted)}
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{padding:10px 12px; text-align:left}
    tbody tr{background:rgba(2,6,23,.6); border:1px solid var(--border)}
    tbody tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .qty{display:inline-flex; align-items:center; gap:6px}
    .qty button{width:28px; height:28px; display:grid; place-items:center; font-weight:700}

    .totals{display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center}
    .totals .label{color:var(--muted)}
    .totals .value{font-weight:700}
    .totals .grand{font-size:20px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .right{margin-left:auto}
    .switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .switch input{display:none}
    .switch .dot{width:36px; height:22px; background:#0b1220; border:1px solid var(--border); border-radius:999px; position:relative}
    .switch .dot::after{content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#64748b; border-radius:50%; transition:.2s}
    .switch input:checked + .dot{border-color:#059669}
    .switch input:checked + .dot::after{left:16px; background:#22c55e}

    .empty{padding:20px; text-align:center; color:var(--muted)}
    .hint{color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>AXIS — cobro</h1>
    <div class="row hint"></div>
  </header>

  <div class="container">
    <!-- Catálogo / Búsqueda -->
    <section class="card" aria-label="catalogo">
      <header class="section row">
        <strong class="grow">Catálogo</strong>
  <!-- IVA removed: no cobrar IVA -->
      </header>
      <div class="section">
        <div class="row" style="gap:12px; margin-bottom:12px">
          <input id="search" placeholder="Buscar producto (nombre o código)…" autocomplete="off" />
          <select id="product-select" aria-label="seleccion-producto" class="grow"></select>
          <input id="qty" type="number" min="1" value="1" style="max-width:110px" />
          <button id="add" class="btn primary">Agregar</button>
        </div>
        <div class="list" id="product-list"></div>
      </div>
    </section>

    <!-- Carrito / Cobro -->
    <section class="card" aria-label="carrito">
      <header class="section row">
        <strong>Carrito</strong>
        <div class="right toolbar">
          <button id="new-sale" class="btn blue" title="Ctrl+N">Nueva venta</button>
          <button id="clear" class="btn warn" title="Del">Vaciar</button>
        </div>
      </header>
      <div class="section" id="cart-wrap">
        <div class="empty" id="empty">No hay productos. Empieza buscando y agrega con “Agregar”.</div>
        <table id="cart" style="display:none">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Código</th>
              <th>Precio</th>
              <th>Cantidad</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cart-body"></tbody>
        </table>
        <hr style="border:0;border-top:1px solid var(--border); margin:14px 0"/>
        <div class="totals">
          <div class="label">Subtotal</div>abri
          <div id="subtotal" class="value">$0.00</div>
          <div class="label grand">Total</div>
          <div id="grand" class="value grand">$0.00</div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button id="print" class="btn">Imprimir ticket</button>
          <button id="export" class="btn">Exportar JSON</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ====== Datos de ejemplo (edita a tu gusto) ======
    const PRODUCTS = [
  { id: 'PS5-0.5', nombre: '1/2 HORA', precio: 13.00, categoria: 'Entretenimiento' },
  { id: 'PS5', nombre: '1 HORA', precio: 23.00, categoria: 'Entretenimiento' },
  { id: 'PS5-1', nombre: '2 HORAS', precio: 40.00, categoria: 'Entretenimiento' },
  { id: 'XBOX-0.5', nombre: '1/2 HORA', precio: 13.00, categoria: 'Entretenimiento' },
  { id: 'XBOX', nombre: '1 HORA', precio: 23.00, categoria: 'Entretenimiento' },
  { id: 'XBOX-1', nombre: '2 HORAS', precio: 40.00, categoria: 'Entretenimiento' },
  { id: 'Meta Quest 3s', nombre: '1 HORA', precio: 30.00, categoria: 'Entretenimiento' },
  { id: 'Meta Quest 3s 2', nombre: '2 HORAS', precio: 50.00, categoria: 'Entretenimiento' },
  { id: 'Meta Quest 3s 1/2', nombre: '1/2 HORAS', precio: 16.00, categoria: 'Entretenimiento' },
      { id: 'MARU', nombre: 'MARUCHAN SABOR 1', precio: 22.00, categoria: 'Snacks' },
      { id: 'MARU-1', nombre: 'MARUCHAN SABOR 2', precio: 22.00,  categoria: 'Snacks' },
      { id: 'MARU-2', nombre: 'MARUCHAN SABOR 3', precio: 22.00, categoria: 'Snacks' },
      { id: 'Agua', nombre: 'Agua', precio: 7.00, categoria: 'Bebidas' },
      { id: 'cock', nombre: 'Coquita', precio: 20.00, categoria: 'Bebidas' },
      { id: 'caca', nombre: 'Cacahuates', precio: 10.00, categoria: 'Botanas' },
    ];

    // ====== Utilidades ======
    const fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function saveState() {
      const state = { cart };
      localStorage.setItem('pos-state', JSON.stringify(state));
    }
    function loadState() {
      try {
        const raw = localStorage.getItem('pos-state');
        if (!raw) return;
        const state = JSON.parse(raw);
        cart = state.cart || [];
        renderCart();
      } catch (e) { console.warn('State load error', e); }
    }

    // ====== Estado ======
    let cart = [];

    // ====== DOM refs ======
    const search = $('#search');
    const productSelect = $('#product-select');
    const list = $('#product-list');
    const qty = $('#qty');
    const addBtn = $('#add');
  // includeIVA removed: IVA not applied

  const cartTable = $('#cart');
  const cartBody = $('#cart-body');
  const empty = $('#empty');
  const subtotalEl = $('#subtotal');
  const grandEl = $('#grand');

    // ====== Inicialización ======
    function populateSelect(products) {
      productSelect.innerHTML = '';
      products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.nombre} — ${fmt.format(p.precio)} (${p.id})`;
        productSelect.appendChild(opt);
      });
    }
    function renderProductList(products){
      list.innerHTML = '';
      products.forEach(p => {
        const item = document.createElement('div');
        item.className = 'product';
        item.innerHTML = `
          <div class="grow">
            <div style="font-weight:600">${p.nombre}</div>
            <small>${p.id} · <span class="pill">${p.categoria}</span></small>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${fmt.format(p.precio)}</div>
            <button class="btn" data-add="${p.id}">Agregar</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    function filterProducts(term){
      const t = term.trim().toLowerCase();
      if(!t) return PRODUCTS;
      return PRODUCTS.filter(p =>
        p.nombre.toLowerCase().includes(t) || p.id.toLowerCase().includes(t) || (p.categoria||'').toLowerCase().includes(t)
      );
    }

    function addToCart(productId, quantity=1){
      const p = PRODUCTS.find(x=>x.id===productId);
      if(!p) return;
      const existing = cart.find(i=>i.id===productId);
      if(existing){
        existing.qty += quantity;
      } else {
        cart.push({ id:p.id, nombre:p.nombre, precio:p.precio, qty: quantity });
      }
      renderCart();
      saveState();
    }

    function removeFromCart(productId){
      cart = cart.filter(i=>i.id!==productId);
      renderCart();
      saveState();
    }

    function setQty(productId, q){
      const item = cart.find(i=>i.id===productId);
      if(!item) return;
      item.qty = Math.max(1, Math.floor(q||1));
      renderCart();
      saveState();
    }

    function adjustQty(productId, delta){
      const item = cart.find(i=>i.id===productId);
      if(!item) return;
      item.qty = Math.max(1, item.qty + delta);
      renderCart();
      saveState();
    }

    function computeTotals(){
      const subtotal = cart.reduce((acc,i)=> acc + i.precio * i.qty, 0);
      const total = subtotal;
      return { subtotal, total };
    }

    function renderCart(){
      if(cart.length===0){
        empty.style.display = 'block';
        cartTable.style.display = 'none';
      } else {
        empty.style.display = 'none';
        cartTable.style.display = 'table';
      }
      cartBody.innerHTML = '';
      cart.forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.nombre}</td>
          <td><span class="pill">${item.id}</span></td>
          <td>${fmt.format(item.precio)}</td>
          <td>
            <div class="qty">
              <button class="btn" data-dec="${item.id}">−</button>
              <input type="number" min="1" value="${item.qty}" data-qty="${item.id}" style="width:70px" />
              <button class="btn" data-inc="${item.id}">+</button>
            </div>
          </td>
          <td><strong>${fmt.format(item.precio*item.qty)}</strong></td>
          <td><button class="btn ghost" data-del="${item.id}" title="Quitar">🗑️</button></td>
        `;
        cartBody.appendChild(tr);
      });
      const {subtotal, total} = computeTotals();
      subtotalEl.textContent = fmt.format(subtotal);
      // IVA removed
      grandEl.textContent = fmt.format(total);
    }

    // ====== Eventos ======
    addBtn.addEventListener('click', ()=>{
      const id = productSelect.value;
      const q = Math.max(1, parseInt(qty.value||'1',10));
      addToCart(id, q);
      qty.value = 1;
      search.focus();
    });

    // Agregar con Enter desde búsqueda o select
    [search, productSelect, qty].forEach(el=>{
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          e.preventDefault(); addBtn.click();
        }
      });
    });

    // Buscar dinámico
    search.addEventListener('input', ()=>{
      const results = filterProducts(search.value);
      populateSelect(results);
      renderProductList(results);
    });

    // Click en lista (botón Agregar)
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-add]');
      if(!btn) return;
      addToCart(btn.dataset.add, 1);
    });

    // Controles del carrito (delegación)
    cartBody.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.matches('[data-del]')) removeFromCart(t.dataset.del);
      if(t.matches('[data-inc]')) adjustQty(t.dataset.inc, +1);
      if(t.matches('[data-dec]')) adjustQty(t.dataset.dec, -1);
    });
    cartBody.addEventListener('change', (e)=>{
      const inp = e.target;
      if(inp.matches('[data-qty]')) setQty(inp.dataset.qty, parseInt(inp.value||'1',10));
    });

  // Toggles y acciones
  // includeIVA removed: no IVA toggle
    $('#clear').addEventListener('click', ()=>{ if(confirm('¿Vaciar carrito?')){ cart=[]; renderCart(); saveState(); }});
    $('#new-sale').addEventListener('click', ()=>{ if(confirm('¿Iniciar nueva venta? Se limpiará el carrito.')){ cart=[]; renderCart(); saveState(); }});

    // Exportar JSON (ahora también intenta subir la venta al servidor)
    $('#export').addEventListener('click', ()=>{
      const payload = {
        items: cart.map(i=>({ id:i.id, nombre:i.nombre, precio:i.precio, cantidad:i.qty, total:i.precio*i.qty })),
        ...computeTotals(),
        fecha: new Date().toISOString()
      };
      // Intentar enviar al servidor (no bloqueante)
      sendSaleToServer(payload).then(r=>{ if(r && r.ok) console.log('Venta subida al servidor'); else if(r && r.queued) console.log('Venta en cola local (sin conexión)'); });
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `venta_${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
    });

    // Imprimir ticket simple
    $('#print').addEventListener('click', ()=>{
      const w = window.open('', 'ticket');
      const {subtotal, total} = computeTotals();
      const rows = cart.map(i=>`<tr><td>${i.nombre} (${i.id})</td><td style="text-align:right">${i.qty} × ${fmt.format(i.precio)}</td><td style="text-align:right">${fmt.format(i.precio*i.qty)}</td></tr>`).join('');
      // Generar folio de 5 caracteres (mayúsculas y números)
      function generarFolio() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let folio = '';
        for (let i = 0; i < 5; i++) {
          folio += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return folio;
      }
      const folio = generarFolio();
      w.document.write(`
        <html><head><meta charset="utf-8"><title>Ticket</title>
        <style>
            /* Ensure printed ticket uses thermal paper width and automatic height */
            @page { size: 58mm auto; margin: 0; }
            html, body { box-sizing: border-box; }
            body{font-family:ui-monospace, Menlo, Consolas; padding:6px 6px 8px 6px; margin:0; font-size:11px; width:58mm;}
            h2{margin:0 0 4px 0; font-size:14px}
            .folio{font-size:12px; font-weight:700; letter-spacing:2px; margin-bottom:4px;}
            table{width:100%; border-collapse:collapse; font-size:11px}
            td{padding:2px 0;}
            tfoot td{font-weight:700}
            hr{border:0; border-top:1px dashed #999; margin:4px 0}
            /* Print-specific rules: enforce page width and remove margins so paper cuts to content */
            @media print {
              @page { size: 58mm auto; margin: 0; }
              html, body { width: 80mm; margin: 0; }
              body { padding:6px 6px 8px 6px; }
            }
          </style></head><body>
        <h2>Ticket de compra</h2>
        <div>${new Date().toLocaleString('es-MX')}</div>
        <div class="folio">Folio: ${folio}</div>
        <hr/>
        <table>${rows}</table>
        <hr/>
        <table>
          <tr><td>Subtotal</td><td style="text-align:right">${fmt.format(subtotal)}</td></tr>
          <tr><td>Total</td><td style="text-align:right">${fmt.format(total)}</td></tr>
        </table>
        <hr/>
        <div style="font-size:11px;">¡Gracias por su compra!</div>
        <script>
          // Focus, print, then close the popup after a short delay. The @page rule requests
          // an automatic height so the printer can cut after content instead of wasting paper.
          window.onload = () => {
            try{ window.focus(); } catch(e){}
            // Give the popup a moment to render fully before printing
            setTimeout(() => {
              window.print();
              // Close after print dialog is shown; adjust delay if your printer needs more time
              setTimeout(() => { try{ window.close(); } catch(e){} }, 700);
            }, 150);
          };
        <\/script>
        </body></html>`);
      w.document.close();
    });

    // Enviar venta al servidor (POST) con cola offline en localStorage
    async function sendSaleToServer(payload){
      const API = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3000/api/sales' : '/api/sales';
      try{
        const res = await fetch(API, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        console.log('Venta guardada en servidor', data);
        // intentar enviar cola pendiente
        flushSaleQueue();
        return data;
      }catch(err){
        console.warn('No se pudo contactar el servidor, guardando en cola local', err);
        // guardar en cola
        const q = JSON.parse(localStorage.getItem('sale-queue')||'[]');
        q.push(payload);
        localStorage.setItem('sale-queue', JSON.stringify(q));
        return { ok:false, queued:true };
      }
    }

    // Intentar enviar ventas en cola
    async function flushSaleQueue(){
      const key = 'sale-queue';
      const q = JSON.parse(localStorage.getItem(key)||'[]');
      if(!q.length) return;
      for(const payload of q.slice()){
        try{
          const res = await fetch((location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3000/api/sales' : '/api/sales', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
          if(res.ok){
            // remover del array
            const idx = q.findIndex(p=>p.fecha===payload.fecha && p.subtotal===payload.subtotal && p.total===payload.total);
            if(idx>=0) q.splice(idx,1);
          }
        }catch(e){
          console.warn('flush error', e); break; // si falla, salimos y probamos después
        }
      }
      localStorage.setItem(key, JSON.stringify(q));
    }

    // Atajos teclado
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key.toLowerCase()==='n'){ e.preventDefault(); $('#new-sale').click(); }
      if(e.key==='Delete'){ e.preventDefault(); $('#clear').click(); }
    });

    // Boot
    populateSelect(PRODUCTS);
    renderProductList(PRODUCTS);
    loadState();
  </script>
</body>
</html>
